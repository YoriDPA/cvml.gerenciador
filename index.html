<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Funcionários</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        /* Custom scrollbar for output area */
        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
        }
        .overflow-y-auto::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        /* Simple spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .form-input {
            @apply mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-2xl border border-gray-200">
        <h1 class="text-3xl font-bold text-center mb-6 text-indigo-700">Gerenciador de Funcionários</h1>

        <!-- User ID Display -->
        <div id="user-info" class="text-sm text-gray-600 text-center mb-4">
            ID do Usuário: <span id="user-id-display" class="font-medium text-indigo-500">Carregando...</span>
        </div>

        <!-- Input and Action Buttons -->
        <div class="flex flex-col sm:flex-row gap-4 mb-4">
            <button id="add-employee-voice-btn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75">
                <i class="fas fa-microphone mr-2"></i> Adicionar Funcionário (Voz)
            </button>
            <button id="add-employee-manual-btn" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-opacity-75">
                <i class="fas fa-plus mr-2"></i> Adicionar Funcionário (Manual)
            </button>
        </div>
        <div class="flex flex-col sm:flex-row gap-4 mb-4">
            <button id="list-employees-btn" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75">
                <i class="fas fa-list mr-2"></i> Listar Funcionários
            </button>
        </div>
        <div class="flex flex-col sm:flex-row gap-4 mb-6">
            <button id="search-employee-voice-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                <i class="fas fa-search mr-2"></i> Buscar Funcionário (Voz)
            </button>
            <button id="search-employee-manual-btn" class="flex-1 bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-opacity-75">
                <i class="fas fa-search mr-2"></i> Buscar Funcionário (Manual)
            </button>
        </div>
        <div class="flex flex-col sm:flex-row gap-4 mb-6">
            <button id="delete-employee-voice-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75">
                <i class="fas fa-trash-alt mr-2"></i> Excluir Funcionário (Voz)
            </button>
            <button id="delete-employee-manual-btn" class="flex-1 bg-rose-600 hover:bg-rose-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-rose-500 focus:ring-opacity-75">
                <i class="fas fa-trash-alt mr-2"></i> Excluir Funcionário (Manual)
            </button>
        </div>

        <!-- Loading Spinner -->
        <div id="loading-spinner" class="hidden flex justify-center items-center my-4">
            <div class="spinner"></div>
            <p class="ml-3 text-gray-700">Processando...</p>
        </div>

        <!-- Error Message Display -->
        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
            <strong class="font-bold">Erro!</strong>
            <span class="block sm:inline" id="error-text"></span>
        </div>

        <!-- Output Area -->
        <div id="output" class="bg-gray-100 p-4 rounded-lg h-96 overflow-y-auto text-gray-800 border border-gray-300 shadow-inner">
            <p class="text-center text-gray-500">Use os botões para interagir com o programa.</p>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center hidden modal-backdrop z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-xl font-semibold mb-4 text-gray-800" id="modal-title">Confirmação</h3>
            <p class="text-gray-700 mb-6" id="modal-message">Você tem certeza?</p>
            <div class="flex justify-end gap-3">
                <button id="modal-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">Cancelar</button>
                <button id="modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Add Employee Modal -->
    <div id="add-employee-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center hidden modal-backdrop z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Adicionar Novo Funcionário</h3>
            <form id="add-employee-form">
                <div class="mb-4">
                    <label for="add-nome" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                    <input type="text" id="add-nome" name="nome" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="add-matricula" class="block text-sm font-medium text-gray-700">Matrícula</label>
                    <input type="text" id="add-matricula" name="matricula" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="add-cargo" class="block text-sm font-medium text-gray-700">Cargo</label>
                    <input type="text" id="add-cargo" name="cargo" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="add-dataAdmissao" class="block text-sm font-medium text-gray-700">Data de Admissão (AAAA-MM-DD)</label>
                    <input type="date" id="add-dataAdmissao" name="dataAdmissao" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="add-telefone" class="block text-sm font-medium text-gray-700">Telefone</label>
                    <input type="text" id="add-telefone" name="telefone" class="form-input">
                </div>
                <div class="mb-4">
                    <label for="add-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="add-email" name="email" class="form-input">
                </div>
                <div class="mb-6">
                    <label for="add-departamento" class="block text-sm font-medium text-gray-700">Departamento</label>
                    <input type="text" id="add-departamento" name="departamento" class="form-input">
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancel-add-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">Cancelar</button>
                    <button type="submit" id="save-add-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Employee Modal -->
    <div id="edit-employee-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center hidden modal-backdrop z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Editar Funcionário</h3>
            <form id="edit-employee-form">
                <input type="hidden" id="edit-originalMatricula">
                <div class="mb-4">
                    <label for="edit-nome" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                    <input type="text" id="edit-nome" name="nome" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="edit-matricula" class="block text-sm font-medium text-gray-700">Matrícula</label>
                    <input type="text" id="edit-matricula" name="matricula" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="edit-cargo" class="block text-sm font-medium text-gray-700">Cargo</label>
                    <input type="text" id="edit-cargo" name="cargo" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="edit-dataAdmissao" class="block text-sm font-medium text-gray-700">Data de Admissão (AAAA-MM-DD)</label>
                    <input type="date" id="edit-dataAdmissao" name="dataAdmissao" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="edit-telefone" class="block text-sm font-medium text-gray-700">Telefone</label>
                    <input type="text" id="edit-telefone" name="telefone" class="form-input">
                </div>
                <div class="mb-4">
                    <label for="edit-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="edit-email" name="email" class="form-input">
                </div>
                <div class="mb-6">
                    <label for="edit-departamento" class="block text-sm font-medium text-gray-700">Departamento</label>
                    <input type="text" id="edit-departamento" name="departamento" class="form-input">
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancel-edit-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">Cancelar</button>
                    <button type="submit" id="save-edit-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Prompt Input Modal (for manual search/delete by matricula) -->
    <div id="prompt-input-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center hidden modal-backdrop z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-xl font-semibold mb-4 text-gray-800" id="prompt-input-title"></h3>
            <p class="text-gray-700 mb-4" id="prompt-input-message"></p>
            <input type="text" id="prompt-input-field" class="form-input mb-6" placeholder="Digite a matrícula...">
            <div class="flex justify-end gap-3">
                <button id="prompt-input-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">Cancelar</button>
                <button id="prompt-input-confirm-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">Confirmar</button>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // VÁRIAVEIS DE CONFIGURAÇÃO DO FIREBASE (SEUS VALORES REAIS!)
        const firebaseConfig = {
          apiKey: "AIzaSyBp4bFUS1Xrrh3Qw3vNXhLL1FruiPoMa_Y",
          authDomain: "cvmlgerenciadorfuncionarios.firebaseapp.com",
          projectId: "cvmlgerenciadorfuncionarios",
          storageBucket: "cvmlgerenciadorfuncionarios.firebasestorage.app",
          messagingSenderId: "989685510582",
          appId: "1:989685510582:web:aed8fd27cc9c300dc31117"
        };

        // Para este aplicativo em GitHub Pages, usaremos o projectId como o appId para consistência com as regras do Firestore
        const appId = firebaseConfig.projectId;

        let app;
        let db;
        let auth;
        let userId;
        let employeesCollectionRef;

        // UI Elements
        const outputDiv = document.getElementById('output');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMessageDiv = document.getElementById('error-message');
        const errorTextSpan = document.getElementById('error-text');
        const userIdDisplay = document.getElementById('user-id-display');

        const addEmployeeVoiceBtn = document.getElementById('add-employee-voice-btn');
        const addEmployeeManualBtn = document.getElementById('add-employee-manual-btn');
        const listEmployeesBtn = document.getElementById('list-employees-btn');
        const searchEmployeeVoiceBtn = document.getElementById('search-employee-voice-btn');
        const searchEmployeeManualBtn = document.getElementById('search-employee-manual-btn');
        const deleteEmployeeVoiceBtn = document.getElementById('delete-employee-voice-btn');
        const deleteEmployeeManualBtn = document.getElementById('delete-employee-manual-btn');

        // Modals
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');

        const addEmployeeModal = document.getElementById('add-employee-modal');
        const addEmployeeForm = document.getElementById('add-employee-form');
        const addNomeInput = document.getElementById('add-nome');
        const addMatriculaInput = document.getElementById('add-matricula');
        const addCargoInput = document.getElementById('add-cargo');
        const addDataAdmissaoInput = document.getElementById('add-dataAdmissao');
        const addTelefoneInput = document.getElementById('add-telefone');
        const addEmailInput = document.getElementById('add-email');
        const addDepartamentoInput = document.getElementById('add-departamento');
        const cancelAddBtn = document.getElementById('cancel-add-btn');
        const saveAddBtn = document.getElementById('save-add-btn');

        const editEmployeeModal = document.getElementById('edit-employee-modal');
        const editEmployeeForm = document.getElementById('edit-employee-form');
        const editOriginalMatriculaInput = document.getElementById('edit-originalMatricula');
        const editNomeInput = document.getElementById('edit-nome');
        const editMatriculaInput = document.getElementById('edit-matricula');
        const editCargoInput = document.getElementById('edit-cargo');
        const editDataAdmissaoInput = document.getElementById('edit-dataAdmissao');
        const editTelefoneInput = document.getElementById('edit-telefone');
        const editEmailInput = document.getElementById('edit-email');
        const editDepartamentoInput = document.getElementById('edit-departamento');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const saveEditBtn = document.getElementById('save-edit-btn');

        const promptInputModal = document.getElementById('prompt-input-modal');
        const promptInputTitle = document.getElementById('prompt-input-title');
        const promptInputMessage = document.getElementById('prompt-input-message');
        const promptInputField = document.getElementById('prompt-input-field');
        const promptInputCancelBtn = document.getElementById('prompt-input-cancel-btn');
        const promptInputConfirmBtn = document.getElementById('prompt-input-confirm-btn');

        let recognition; // Web Speech API SpeechRecognition object
        let currentOnConfirmPromptInput = null; // Callback for prompt input modal


        // --- Firebase Initialization and Authentication ---
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Fora do ambiente Canvas, sempre faremos login anonimamente
                await signInAnonymously(auth);

                // Listen for auth state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        // Set up the employees collection path using the provided appId (now projectId)
                        employeesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/employees`);
                        displayMessage("Firebase inicializado e usuário autenticado. Pronto para operar!");
                        setupRealtimeListener(); // Start listening for employee changes
                    } else {
                        userId = null;
                        userIdDisplay.textContent = 'Não autenticado';
                        displayError("Falha na autenticação do Firebase. Tente novamente.");
                    }
                });
            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                displayError(`Erro ao inicializar Firebase: ${error.message}. Por favor, verifique suas configurações do Firebase.`);
            }
        }

        // --- Utility Functions ---
        function showLoading() {
            loadingSpinner.classList.remove('hidden');
            outputDiv.innerHTML = '<p class="text-center text-gray-500">Processando seu pedido...</p>';
            hideError();
        }

        function hideLoading() {
            loadingSpinner.classList.add('hidden');
        }

        function displayMessage(message, isHtml = false) {
            hideLoading();
            hideError();
            if (isHtml) {
                outputDiv.innerHTML = message;
            } else {
                outputDiv.innerHTML = `<p>${message}</p>`;
            }
            outputDiv.scrollTop = outputDiv.scrollHeight; // Scroll to bottom
        }

        function displayError(message) {
            hideLoading();
            errorMessageDiv.classList.remove('hidden');
            errorTextSpan.textContent = message;
            outputDiv.innerHTML = `<p class="text-red-600 font-semibold">${message}</p>`; // Also display in output
        }

        function hideError() {
            errorMessageDiv.classList.add('hidden');
            errorTextSpan.textContent = '';
        }

        // General Modal Open/Close
        function openModal(modalElement) {
            modalElement.classList.remove('hidden');
            modalElement.classList.add('flex'); // Ensure flex for centering
        }

        function closeModal(modalElement) {
            modalElement.classList.add('hidden');
            modalElement.classList.remove('flex');
        }

        // Show confirmation modal
        function showConfirmationModal(title, message, onConfirm) {
            openModal(confirmationModal);
            modalTitle.textContent = title;
            modalMessage.textContent = message;

            // Clear previous listeners
            modalConfirmBtn.onclick = null;
            modalCancelBtn.onclick = null;

            modalConfirmBtn.onclick = () => {
                closeModal(confirmationModal);
                onConfirm(true);
            };
            modalCancelBtn.onclick = () => {
                closeModal(confirmationModal);
                onConfirm(false);
            };
        }

        // Show prompt input modal
        function showPromptInputModal(title, message, onConfirm) {
            openModal(promptInputModal);
            promptInputTitle.textContent = title;
            promptInputMessage.textContent = message;
            promptInputField.value = ''; // Clear previous input
            promptInputField.focus(); // Focus on input field

            currentOnConfirmPromptInput = onConfirm; // Store callback

            // Clear previous listeners
            promptInputConfirmBtn.onclick = null;
            promptInputCancelBtn.onclick = null;

            promptInputConfirmBtn.onclick = () => {
                closeModal(promptInputModal);
                currentOnConfirmPromptInput(promptInputField.value);
            };
            promptInputCancelBtn.onclick = () => {
                closeModal(promptInputModal);
                currentOnConfirmPromptInput(null); // Or false, depending on desired behavior
            };
        }

        // Exponential backoff for API calls
        async function fetchWithBackoff(url, options, retries = 5, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    } else if (response.status === 429 || response.status >= 500) {
                        // Too many requests or server error, retry
                        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                    } else {
                        // Other client errors, don't retry
                        const errorData = await response.json();
                        throw new Error(`API Error: ${response.status} ${response.statusText} - ${JSON.stringify(errorData)}`);
                    }
                } catch (error) {
                    if (i === retries - 1) throw error; // Re-throw if last retry
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }
        }

        // --- Web Speech API (Voice Recognition) ---
        function startVoiceRecognition(callback) {
            if (!('webkitSpeechRecognition' in window)) {
                displayError("Desculpe, seu navegador não suporta reconhecimento de voz. Por favor, use Chrome.");
                return;
            }

            recognition = new webkitSpeechRecognition();
            recognition.continuous = false; // Only one result per recognition
            recognition.lang = 'pt-BR'; // Set language to Brazilian Portuguese
            recognition.interimResults = false;

            recognition.onstart = () => {
                displayMessage("Ouvindo... por favor, fale seu comando.");
                // Update specific voice buttons based on which one was clicked
                if (addEmployeeVoiceBtn.classList.contains('bg-indigo-600')) {
                    addEmployeeVoiceBtn.textContent = 'Ouvindo...';
                    addEmployeeVoiceBtn.classList.add('bg-orange-500');
                    addEmployeeVoiceBtn.classList.remove('bg-indigo-600');
                } else if (searchEmployeeVoiceBtn.classList.contains('bg-blue-600')) {
                    searchEmployeeVoiceBtn.textContent = 'Ouvindo...';
                    searchEmployeeVoiceBtn.classList.add('bg-orange-500');
                    searchEmployeeVoiceBtn.classList.remove('bg-blue-600');
                } else if (deleteEmployeeVoiceBtn.classList.contains('bg-red-600')) {
                    deleteEmployeeVoiceBtn.textContent = 'Ouvindo...';
                    deleteEmployeeVoiceBtn.classList.add('bg-orange-500');
                    deleteEmployeeVoiceBtn.classList.remove('bg-red-600');
                }
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                displayMessage(`Você disse: "${transcript}". Processando...`);
                callback(transcript);
            };

            recognition.onerror = (event) => {
                console.error('Erro no reconhecimento de voz:', event.error);
                if (event.error === 'no-speech') {
                    displayError('Nenhuma fala detectada. Por favor, tente novamente.');
                } else if (event.error === 'not-allowed') {
                    displayError('Permissão para microfone negada. Por favor, habilite nas configurações do navegador.');
                } else {
                    displayError(`Erro no reconhecimento de voz: ${event.error}`);
                }
                resetVoiceButtons();
            };

            recognition.onend = () => {
                resetVoiceButtons();
            };

            recognition.start();
        }

        function resetVoiceButtons() {
            addEmployeeVoiceBtn.textContent = 'Adicionar Funcionário (Voz)';
            addEmployeeVoiceBtn.classList.remove('bg-orange-500');
            addEmployeeVoiceBtn.classList.add('bg-indigo-600');
            searchEmployeeVoiceBtn.textContent = 'Buscar Funcionário (Voz)';
            searchEmployeeVoiceBtn.classList.remove('bg-orange-500');
            searchEmployeeVoiceBtn.classList.add('bg-blue-600');
            deleteEmployeeVoiceBtn.textContent = 'Excluir Funcionário (Voz)';
            deleteEmployeeVoiceBtn.classList.remove('bg-orange-500');
            deleteEmployeeVoiceBtn.classList.add('bg-red-600');
        }

        // --- LLM (Gemini API) Integration ---
        async function callGeminiAPI(prompt, schema = null) {
            showLoading();
            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                let payload = { contents: chatHistory };
                if (schema) {
                    payload.generationConfig = {
                        responseMimeType: "application/json",
                        responseSchema: schema
                    };
                }

                const apiKey = ""; // Canvas will provide this if empty
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const textResponse = result.candidates[0].content.parts[0].text;
                    if (schema) {
                        try {
                            return JSON.parse(textResponse);
                        } catch (e) {
                            console.error("Erro ao fazer parse do JSON da API Gemini:", e);
                            displayError("A IA retornou um formato de dados inválido.");
                            throw e;
                        }
                    }
                    return textResponse;
                } else {
                    throw new Error("Resposta da API Gemini inesperada ou vazia.");
                }
            } catch (error) {
                console.error("Erro ao chamar API Gemini:", error);
                displayError(`Falha ao processar comando com a IA: ${error.message}`);
                throw error; // Re-throw to propagate error for further handling
            } finally {
                hideLoading();
            }
        }

        // --- Employee Management Functions (Firestore) ---
        async function addEmployee(employeeData) {
            showLoading();
            try {
                // Check for existing employee with the same 'matricula'
                const q = query(employeesCollectionRef, where("matricula", "==", employeeData.matricula));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    displayError(`Já existe um funcionário com a matrícula ${employeeData.matricula}.`);
                    return false;
                }

                // Add document with expanded fields
                await addDoc(employeesCollectionRef, {
                    nome: employeeData.nome,
                    matricula: employeeData.matricula,
                    cargo: employeeData.cargo,
                    dataAdmissao: employeeData.dataAdmissao,
                    telefone: employeeData.telefone || '', // Add new fields with default empty string
                    email: employeeData.email || '',
                    departamento: employeeData.departamento || ''
                });
                displayMessage(`Funcionário "${employeeData.nome}" (Matrícula: ${employeeData.matricula}) adicionado com sucesso!`);
                return true;
            } catch (error) {
                console.error("Erro ao adicionar funcionário:", error);
                displayError(`Falha ao adicionar funcionário: ${error.message}`);
                return false;
            } finally {
                hideLoading();
            }
        }

        async function getEmployee(matricula) {
            showLoading();
            try {
                const q = query(employeesCollectionRef, where("matricula", "==", matricula));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    displayMessage(`Funcionário com matrícula ${matricula} não encontrado.`);
                    return null;
                }
                // Get the document ID for future updates/deletes if needed directly
                const docId = querySnapshot.docs[0].id;
                const docData = querySnapshot.docs[0].data();
                displayEmployeeDossier({ ...docData, id: docId }); // Pass docId along with data
                return { ...docData, id: docId };
            } catch (error) {
                console.error("Erro ao buscar funcionário:", error);
                displayError(`Falha ao buscar funcionário: ${error.message}`);
                return null;
            } finally {
                hideLoading();
            }
        }

        // New function: Update Employee
        async function updateEmployee(originalMatricula, newData) {
            showLoading();
            try {
                // Find the document using the original matricula
                const q = query(employeesCollectionRef, where("matricula", "==", originalMatricula));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    displayError(`Funcionário com matrícula ${originalMatricula} não encontrado para atualização.`);
                    return false;
                }

                const docToUpdate = querySnapshot.docs[0];
                const docRef = doc(db, employeesCollectionRef.path, docToUpdate.id);

                // If matricula was changed, ensure the new one doesn't exist
                if (originalMatricula !== newData.matricula) {
                    const checkNewMatriculaQ = query(employeesCollectionRef, where("matricula", "==", newData.matricula));
                    const checkSnapshot = await getDocs(checkNewMatriculaQ);
                    if (!checkSnapshot.empty) {
                        displayError(`A nova matrícula "${newData.matricula}" já está em uso por outro funcionário.`);
                        return false;
                    }
                }

                await updateDoc(docRef, {
                    nome: newData.nome,
                    matricula: newData.matricula,
                    cargo: newData.cargo,
                    dataAdmissao: newData.dataAdmissao,
                    telefone: newData.telefone || '',
                    email: newData.email || '',
                    departamento: newData.departamento || ''
                });
                displayMessage(`Funcionário "${newData.nome}" (Matrícula: ${newData.matricula}) atualizado com sucesso!`);
                return true;
            } catch (error) {
                console.error("Erro ao atualizar funcionário:", error);
                displayError(`Falha ao atualizar funcionário: ${error.message}`);
                return false;
            } finally {
                hideLoading();
            }
        }


        function displayEmployeeDossier(employee) {
            // Ensure dataAdmissao is a valid date string
            const admissionDate = new Date(employee.dataAdmissao);
            const today = new Date();
            let timeInCompany = 'N/A';

            if (!isNaN(admissionDate.getTime())) { // Check if date is valid
                const timeDiff = Math.abs(today.getTime() - admissionDate.getTime());
                const diffDays = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));

                const years = Math.floor(diffDays / 365);
                const remainingDaysAfterYears = diffDays % 365;
                const months = Math.floor(remainingDaysAfterYears / 30.4375); // Average days in a month
                const days = Math.floor(remainingDaysAfterYears % 30.4375);

                const parts = [];
                if (years > 0) parts.push(`${years} ano(s)`);
                if (months > 0) parts.push(`${months} mês(es)`);
                if (days > 0) parts.push(`${days} dia(s)`);
                timeInCompany = parts.join(', ') || 'Menos de um dia';
            }


            const dossierHtml = `
                <div class="bg-blue-50 p-4 rounded-lg shadow-md mb-4">
                    <h3 class="text-xl font-bold text-blue-800 mb-2">Dossiê do Funcionário</h3>
                    <p><strong>Nome:</strong> ${employee.nome}</p>
                    <p><strong>Matrícula:</strong> ${employee.matricula}</p>
                    <p><strong>Cargo:</strong> ${employee.cargo}</p>
                    <p><strong>Departamento:</strong> ${employee.departamento || 'Não informado'}</p>
                    <p><strong>Data de Admissão:</strong> ${!isNaN(admissionDate.getTime()) ? admissionDate.toLocaleDateString('pt-BR') : 'Data inválida'}</p>
                    <p><strong>Tempo na Empresa:</strong> ${timeInCompany}</p>
                    <p><strong>Telefone:</strong> ${employee.telefone || 'Não informado'}</p>
                    <p><strong>Email:</strong> ${employee.email || 'Não informado'}</p>
                    <div class="flex gap-2 mt-4">
                        <button id="edit-employee-dossier-btn" data-matricula="${employee.matricula}" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-md focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-opacity-75">
                            <i class="fas fa-edit mr-2"></i> Editar
                        </button>
                        <button id="delete-employee-dossier-btn" data-matricula="${employee.matricula}" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75">
                            <i class="fas fa-trash-alt mr-2"></i> Excluir
                        </button>
                    </div>
                </div>
            `;
            displayMessage(dossierHtml, true);

            // Add event listeners to the new buttons within the output
            document.getElementById('edit-employee-dossier-btn').addEventListener('click', () => {
                openEditEmployeeModal(employee);
            });
            document.getElementById('delete-employee-dossier-btn').addEventListener('click', () => {
                const matriculaToDelete = employee.matricula;
                showConfirmationModal(
                    "Confirmar Exclusão",
                    `Tem certeza que deseja excluir o funcionário com matrícula ${matriculaToDelete}?`,
                    async (confirmed) => {
                        if (confirmed) {
                            await deleteEmployee(matriculaToDelete);
                        } else {
                            displayMessage("Exclusão cancelada.");
                        }
                    }
                );
            });
        }

        function displayEmployeeList(employees) {
            if (employees.length === 0) {
                displayMessage("Nenhum funcionário cadastrado ainda.");
                return;
            }

            let listHtml = `
                <div class="bg-purple-50 p-4 rounded-lg shadow-md mb-4">
                    <h3 class="text-xl font-bold text-purple-800 mb-2">Lista de Funcionários (${employees.length})</h3>
                    <ul class="list-disc pl-5">
            `;
            employees.forEach(emp => {
                listHtml += `<li><strong>${emp.nome}</strong> (Matrícula: ${emp.matricula}) - Cargo: ${emp.cargo} - Depto: ${emp.departamento || 'N/A'}</li>`;
            });
            listHtml += `
                    </ul>
                </div>
            `;
            displayMessage(listHtml, true);
        }

        async function deleteEmployee(matricula) {
            showLoading();
            try {
                const q = query(employeesCollectionRef, where("matricula", "==", matricula));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    displayError(`Funcionário com matrícula ${matricula} não encontrado para exclusão.`);
                    return false;
                }
                const docToDelete = querySnapshot.docs[0];
                await deleteDoc(doc(db, employeesCollectionRef.path, docToDelete.id));
                displayMessage(`Funcionário com matrícula ${matricula} excluído com sucesso!`);
                return true;
            } catch (error) {
                console.error("Erro ao excluir funcionário:", error);
                displayError(`Falha ao excluir funcionário: ${error.message}`);
                return false;
            } finally {
                hideLoading();
            }
        }

        // Real-time listener for employee data
        function setupRealtimeListener() {
            if (employeesCollectionRef && userId) {
                onSnapshot(employeesCollectionRef, (snapshot) => {
                    const employees = [];
                    snapshot.forEach(doc => {
                        employees.push({ id: doc.id, ...doc.data() });
                    });
                    // Only update the display if the user is currently viewing the list
                    // or if it's the initial load and no other specific action is in progress
                    if (outputDiv.innerHTML.includes('Lista de Funcionários') ||
                        outputDiv.innerHTML.includes('Nenhum funcionário cadastrado')) {
                        displayEmployeeList(employees.sort((a, b) => a.nome.localeCompare(b.nome)));
                    }
                    // If a specific dossier is currently shown, update it
                    const currentMatriculaInDossier = outputDiv.querySelector('#edit-employee-dossier-btn')?.dataset.matricula;
                    if (currentMatriculaInDossier) {
                        const updatedEmployee = employees.find(emp => emp.matricula === currentMatriculaInDossier);
                        if (updatedEmployee) {
                            displayEmployeeDossier(updatedEmployee); // Re-render with updated data
                        } else {
                            displayMessage(`O funcionário com matrícula ${currentMatriculaInDossier} foi removido.`);
                        }
                    }

                }, (error) => {
                    console.error("Erro no listener em tempo real:", error);
                    displayError(`Erro ao atualizar lista em tempo real: ${error.message}`);
                });
            }
        }


        // --- Event Handlers ---
        addEmployeeVoiceBtn.addEventListener('click', () => {
            if (!userId) {
                displayError("Autenticação não concluída. Por favor, aguarde ou recarregue a página.");
                return;
            }
            startVoiceRecognition(async (transcript) => {
                const schema = {
                    type: "OBJECT",
                    properties: {
                        "nome": { "type": "STRING" },
                        "matricula": { "type": "STRING" },
                        "cargo": { "type": "STRING" },
                        "dataAdmissao": { "type": "STRING" }, // YYYY-MM-DD
                        "telefone": { "type": "STRING", "nullable": true },
                        "email": { "type": "STRING", "nullable": true },
                        "departamento": { "type": "STRING", "nullable": true }
                    },
                    required: ["nome", "matricula", "cargo", "dataAdmissao"]
                };
                const prompt = `Extraia as informações de funcionário (nome, matrícula, cargo, data de admissão no formato AAAA-MM-DD, telefone, email, departamento) da seguinte frase, em português brasileiro: "${transcript}". Se a data de admissão não for clara, tente inferir do contexto ou use uma data padrão como hoje. Se telefone, email ou departamento não forem mencionados, use nulo.`;
                try {
                    const parsedData = await callGeminiAPI(prompt, schema);

                    if (parsedData && parsedData.nome && parsedData.matricula && parsedData.cargo && parsedData.dataAdmissao) {
                        // Basic date validation
                        if (isNaN(new Date(parsedData.dataAdmissao).getTime())) {
                            displayError("Data de admissão inválida. Por favor, forneça no formato AAAA-MM-DD.");
                            return;
                        }
                        await addEmployee(parsedData);
                    } else {
                        displayError("Não consegui extrair todas as informações essenciais (Nome, Matrícula, Cargo, Data de Admissão). Por favor, tente novamente com mais detalhes.");
                    }
                } catch (error) {
                    // Error already displayed by callGeminiAPI
                }
            });
        });

        // Event listener for manual add employee button
        addEmployeeManualBtn.addEventListener('click', () => {
            if (!userId) {
                displayError("Autenticação não concluída. Por favor, aguarde ou recarregue a página.");
                return;
            }
            openModal(addEmployeeModal);
            addEmployeeForm.reset(); // Clear form fields
            addNomeInput.focus(); // Focus on the first input
        });

        // Event listener for saving manual add employee form
        addEmployeeForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Prevent default form submission
            const employeeData = {
                nome: addNomeInput.value,
                matricula: addMatriculaInput.value,
                cargo: addCargoInput.value,
                dataAdmissao: addDataAdmissaoInput.value,
                telefone: addTelefoneInput.value,
                email: addEmailInput.value,
                departamento: addDepartamentoInput.value
            };

            if (!employeeData.nome || !employeeData.matricula || !employeeData.cargo || !employeeData.dataAdmissao) {
                displayError("Por favor, preencha todos os campos obrigatórios (Nome, Matrícula, Cargo, Data de Admissão).");
                return;
            }
            if (isNaN(new Date(employeeData.dataAdmissao).getTime())) {
                displayError("Data de admissão inválida. Por favor, forneça no formato AAAA-MM-DD.");
                return;
            }

            const success = await addEmployee(employeeData);
            if (success) {
                closeModal(addEmployeeModal);
            }
        });

        // Event listener for canceling manual add employee form
        cancelAddBtn.addEventListener('click', () => {
            closeModal(addEmployeeModal);
        });


        listEmployeesBtn.addEventListener('click', async () => {
            if (!userId) {
                displayError("Autenticação não concluída. Por favor, aguarde ou recarregue a página.");
                return;
            }
            showLoading();
            try {
                const querySnapshot = await getDocs(employeesCollectionRef);
                const employees = [];
                querySnapshot.forEach(doc => {
                    employees.push(doc.data());
                });
                displayEmployeeList(employees.sort((a, b) => a.nome.localeCompare(b.nome))); // Sort by name
            } catch (error) {
                console.error("Erro ao listar funcionários:", error);
                displayError(`Falha ao listar funcionários: ${error.message}`);
            } finally {
                hideLoading();
            }
        });

        searchEmployeeVoiceBtn.addEventListener('click', () => {
            if (!userId) {
                displayError("Autenticação não concluída. Por favor, aguarde ou recarregue a página.");
                return;
            }
            startVoiceRecognition(async (transcript) => {
                const schema = {
                    type: "OBJECT",
                    properties: { "matricula": { "type": "STRING" } },
                    required: ["matricula"]
                };
                const prompt = `Extraia a matrícula do funcionário da seguinte frase, em português brasileiro: "${transcript}". A matrícula deve ser um número ou uma string.`;
                try {
                    const parsedData = await callGeminiAPI(prompt, schema);
                    if (parsedData && parsedData.matricula) {
                        await getEmployee(parsedData.matricula);
                    } else {
                        displayError("Não consegui extrair a matrícula. Por favor, diga a matrícula do funcionário claramente.");
                    }
                } catch (error) {
                    // Error already displayed by callGeminiAPI
                }
            });
        });

        // Event listener for manual search employee button
        searchEmployeeManualBtn.addEventListener('click', () => {
            if (!userId) {
                displayError("Autenticação não concluída. Por favor, aguarde ou recarregue a página.");
                return;
            }
            showPromptInputModal("Buscar Funcionário", "Digite a matrícula do funcionário que deseja buscar:", async (matricula) => {
                if (matricula) {
                    await getEmployee(matricula);
                } else {
                    displayMessage("Busca de funcionário cancelada ou matrícula não fornecida.");
                }
            });
        });


        deleteEmployeeVoiceBtn.addEventListener('click', () => {
            if (!userId) {
                displayError("Autenticação não concluída. Por favor, aguarde ou recarregue a página.");
                return;
            }
            startVoiceRecognition(async (transcript) => {
                const schema = {
                    type: "OBJECT",
                    properties: { "matricula": { "type": "STRING" } },
                    required: ["matricula"]
                };
                const prompt = `Extraia a matrícula do funcionário da seguinte frase, em português brasileiro: "${transcript}". A matrícula deve ser um número ou uma string.`;
                try {
                    const parsedData = await callGeminiAPI(prompt, schema);
                    if (parsedData && parsedData.matricula) {
                        const matricula = parsedData.matricula;
                        showConfirmationModal(
                            "Confirmar Exclusão",
                            `Tem certeza que deseja excluir o funcionário com matrícula ${matricula}?`,
                            async (confirmed) => {
                                if (confirmed) {
                                    await deleteEmployee(matricula);
                                } else {
                                    displayMessage("Exclusão cancelada.");
                                }
                            }
                        );
                    } else {
                        displayError("Não consegui extrair a matrícula. Por favor, diga a matrícula do funcionário a ser excluído claramente.");
                    }
                } catch (error) {
                    // Error already displayed by callGeminiAPI
                }
            });
        });

        // Event listener for manual delete employee button
        deleteEmployeeManualBtn.addEventListener('click', () => {
            if (!userId) {
                displayError("Autenticação não concluída. Por favor, aguarde ou recarregue a página.");
                return;
            }
            showPromptInputModal("Excluir Funcionário", "Digite a matrícula do funcionário que deseja excluir:", async (matricula) => {
                if (matricula) {
                    showConfirmationModal(
                        "Confirmar Exclusão",
                        `Tem certeza que deseja excluir o funcionário com matrícula ${matricula}?`,
                        async (confirmed) => {
                            if (confirmed) {
                                await deleteEmployee(matricula);
                            } else {
                                displayMessage("Exclusão cancelada.");
                            }
                        }
                    );
                } else {
                    displayMessage("Exclusão de funcionário cancelada ou matrícula não fornecida.");
                }
            });
        });


        // Function to open Edit Employee Modal and pre-fill data
        function openEditEmployeeModal(employeeData) {
            openModal(editEmployeeModal);
            editOriginalMatriculaInput.value = employeeData.matricula; // Store original matricula for update query
            editNomeInput.value = employeeData.nome;
            editMatriculaInput.value = employeeData.matricula; // Allow changing matricula
            editCargoInput.value = employeeData.cargo;
            editDataAdmissaoInput.value = employeeData.dataAdmissao;
            editTelefoneInput.value = employeeData.telefone || '';
            editEmailInput.value = employeeData.email || '';
            editDepartamentoInput.value = employeeData.departamento || '';
            editNomeInput.focus();
        }

        // Event listener for saving manual edit employee form
        editEmployeeForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Prevent default form submission
            const originalMatricula = editOriginalMatriculaInput.value;
            const updatedData = {
                nome: editNomeInput.value,
                matricula: editMatriculaInput.value,
                cargo: editCargoInput.value,
                dataAdmissao: editDataAdmissaoInput.value,
                telefone: editTelefoneInput.value,
                email: editEmailInput.value,
                departamento: editDepartamentoInput.value
            };

            if (!updatedData.nome || !updatedData.matricula || !updatedData.cargo || !updatedData.dataAdmissao) {
                displayError("Por favor, preencha todos os campos obrigatórios (Nome, Matrícula, Cargo, Data de Admissão).");
                return;
            }
            if (isNaN(new Date(updatedData.dataAdmissao).getTime())) {
                displayError("Data de admissão inválida. Por favor, forneça no formato AAAA-MM-DD.");
                return;
            }

            const success = await updateEmployee(originalMatricula, updatedData);
            if (success) {
                closeModal(editEmployeeModal);
            }
        });

        // Event listener for canceling manual edit employee form
        cancelEditBtn.addEventListener('click', () => {
            closeModal(editEmployeeModal);
        });


        // Initialize Firebase when the window loads
        window.onload = initializeFirebase;
    </script>
    <!-- Font Awesome for icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>
</body>
</html>
